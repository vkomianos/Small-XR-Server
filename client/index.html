<html>

	<head>
		<script src="js/aframe.min.1.6.0.js">
		</script>
	</head>
	
	<script>
	
		let userID = (Math.random() + 1).toString(36).substring(2) + (Math.random() + 1).toString(36).substring(2);
		console.log(userID);
	
		AFRAME.registerComponent('update-position', {
        init: function () {
          this.playerEl = this.el;
		  
		  //console.log("Player element: " + this.el);
		  //console.log("Player element: " + this.el.getAttribute('position').x);
         
          // Event listener for keydown event
          //window.addEventListener('keydown', this.onKeyDown.bind(this));
		  window.addEventListener('keypress', this.onKeyPress.bind(this));
          
          // Event listener for keyup event
          //window.addEventListener('keyup', this.onKeyUp.bind(this));
        }
		/*
		,
        onKeyDown: function (event) {
          console.log("Keydown:" + event.key);
		  
		  if (event.key == 'w' || event.key == 'a' || event.key == 's' || event.key == 'd' || event.key == 'ArrowUp' || event.key == 'ArrowLeft' || event.key == 'ArrowDown' || event.key == 'ArrowRight' ) {
           
          }
        }*/
		,
		onKeyPress: function (event) {
          //console.log("Keypress: "+ event.key);
		  if (event.key == 'w' || event.key == 'a' || event.key == 's' || event.key == 'd' || event.key == 'ArrowUp' || event.key == 'ArrowLeft' || event.key == 'ArrowDown' || event.key == 'ArrowRight' ) {
           updatePosition(this.el.getAttribute('position'));
          }
        }
		/*,
        onKeyUp: function (event) {
          if (event.key == 'Shift') {
            
          }
        }*/
      });
	</script>
	

	<body>
		<a-scene>
			<a-sky color="lightblue"></a-sky>
			
			<a-entity camera look-controls wasd-controls position="0 1.6 3" update-position >
				<a-torus-knot position="0 0 -2" color="#B84A39" arc="180" p="2" q="7" radius="5" radius-tubular="0.1"></a-torus-knot>
				<a-cursor></a-cursor>
				<!--<a-text  id="msg-1" value="TEST" position="-3.5 .2 -2"></a-text>-->
			</a-entity>
			
			<a-box color="red" position="0 0 -10"></a-box>
	
		</a-scene>
	</body>
	
	<script>
	
	const interval = setInterval(repeat, 250);
	
	function repeat()
	{
		retrieveUsersAndPositions();
	}
	
	function updatePosition(position)
	{
		//console.log("Position: " + position.x + "," + position.y + "," + position.z);
		let postData = "command=update&userID="+userID+"&position='"+position.x + ","+position.y +","+position.z + "'";
		
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.open("POST", "http://localhost/multiuser-xr-server/server/index.php", true);
		xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xmlhttp.send(postData);
		
		console.log("POST data: " + postData);
	}
	
	function retrieveUsersAndPositions()
	{
		let postData = "command=retrieve";
		
		var xhr = new XMLHttpRequest();
		
		xhr.onreadystatechange = function()
		{
			if (xhr.readyState == XMLHttpRequest.DONE)
				showUsers(xhr);
		}
		
		xhr.open("POST", "http://localhost/multiuser-xr-server/server/index.php", true);
		xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhr.send(postData);
	}
	
	function showUsers(xhr)
	{
		//console.log("Show users: " + xhr.responseText);
		console.log("Active users: " + JSON.parse(xhr.responseText).length);
		
		let data = JSON.parse(xhr.responseText);
		
		for (let i = 0; i < data.length; i++)
		{
			console.log(data[i].userID + " - " + data[i].position);
		}
		
	}
	
		
	</script>

</html>